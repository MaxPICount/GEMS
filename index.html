<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>CV & Cover Letter Generator</title>
	<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

	<style>
        .cv-builder {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 1rem;
        }

        /* Левая и правая панели */
        .form-panel, .preview-panel {
            flex: 1 1 400px;
            border: 1px solid #ccc;
            padding: 1rem;
            border-radius: 0.5rem;
            background: #f9f9f9;
            min-width: 300px;
        }

        /* Сделаем превью красивее */
        .preview-panel {
            background: #fff;
        }

        /* На мобильных — в колонку */
        @media (max-width: 768px) {
            .cv-builder {
                flex-direction: column;
            }
        }
	</style>

</head>
<body>
<div id="app">
	<div class="cv-builder">

		<!-- form -->
		<div class="form-panel">
			<h2>CV Generator</h2>

			<div class="mb-3">
				<label>Name:</label>
				<input v-model="form.name" class="form-control" />
			</div>
			<div class="mb-3">
				<label>Email:</label>
				<input v-model="form.email" class="form-control" />
			</div>
			<div class="mb-3">
				<label>Job Title:</label>
				<input v-model="form.position" class="form-control" />
			</div>
			<div class="mb-3">
				<label>Experience:</label>
				<div class="mb-3">
					<label>Experience:</label>
					<button class="btn btn-outline-secondary mb-3" data-bs-toggle="modal" data-bs-target="#experienceModal">
						Add Experience
					</button>
				</div>
			</div>
			<div class="mb-3">
				<label>Education:</label>
				<textarea v-model="form.education" class="form-control"></textarea>
			</div>
			<div class="mb-3">
				<label>Skills:</label>
				<textarea v-model="form.skills" class="form-control"></textarea>
			</div>
			<div class="mb-3">
				<label>Hobbies:</label>
				<textarea v-model="form.hobbies" class="form-control"></textarea>
			</div>

			<div class="d-grid gap-2 mt-3">
				<button @click="customizeWithAI" class="btn btn-primary">Customize with AI</button>
				<button @click="downloadPDF" class="btn btn-success">Download PDF</button>
			</div>
		</div>

		<!-- preview -->
		<div class="preview-panel" id="preview">
			<h3>{{ form.name }}</h3>
			<p><strong>Email:</strong> {{ form.email }}</p>
			<p><strong>Target Job:</strong> {{ form.position }}</p>
			<p><strong>Summary:</strong> {{ aiSuggestions.summary }}</p>

			<h4>Experience</h4>
			<div v-for="(exp, index) in form.experienceList" :key="index" class="mb-2">
				<strong>{{ exp.years }}</strong> | <strong>{{ exp.position }}</strong> @ {{ exp.company }}<br>
				<small>{{ exp.description }}</small>
			</div>

			<h4>Education</h4>
			<p>{{ form.education }}</p>

			<h4>Skills</h4>
			<p>{{ form.skills }}</p>

			<h4>Hobbies</h4>
			<p>{{ form.hobbies }}</p>

			<h4>Cover Letter</h4>
			<p>{{ aiSuggestions.coverLetter }}</p>
		</div>

	</div>
	<div class="modal fade" id="experienceModal" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Add Experience</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<div class="mb-2">
						<label>Company:</label>
						<input v-model="newExperience.company" class="form-control" />
					</div>
					<div class="mb-2">
						<label>Position:</label>
						<input v-model="newExperience.position" class="form-control" />
					</div>
					<div class="mb-2">
						<label>Years:</label>
						<input v-model="newExperience.years" class="form-control" />
					</div>
					<div class="mb-2">
						<label>Description:</label>
						<textarea v-model="newExperience.description" class="form-control"></textarea>
					</div>
				</div>
				<div class="modal-footer">
					<button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button class="btn btn-primary" @click="addExperience" data-bs-dismiss="modal">Save</button>
				</div>
			</div>
		</div>
	</div>
</div>


<script>
    const
        {createApp} = Vue,
        OpenRouteKey = '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',
        OpenRouteModel = 'deepseek/deepseek-r1:free';

    createApp({
        data() {
            return {
                form: {
                    name: '',
                    email: '',
                    position: '',
                    experienceList: [],
                    education: '',
                    skills: '',
                    hobbies: '',
                },
                aiSuggestions: {
                    summary: '',
                    experienceBullets: [],
                    coverLetter: '',
                },
                newExperience: {
                    company: '',
                    position: '',
                    years: '',
                    description: '',
                },
            };
        },
        methods: {
            downloadPDF() {
                const element = document.getElementById('preview');
                html2pdf().set({
                    margin: 10,
                    filename: 'cv.pdf',
                    html2canvas: {scale: 2},
                    jsPDF: {unit: 'mm', format: 'a4', orientation: 'portrait'}
                }).from(element).save();
            },
            async customizeWithAI() {
                const
                    {form, aiSuggestions} = this,
                    prompt = `
You are a helpful assistant that tailors resumes and cover letters.

User details:
- Name: ${form.name}
- Target Job Title: ${form.position}
- Work Experience: ${form.experience}
- Education: ${form.education}
- Skills: ${form.skills}
- Hobbies: ${form.hobbies}
`.trim();

                try {
                    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${OpenRouteKey}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            model: OpenRouteModel,
                            messages: [
                                {role: "system", content: "You are a helpful assistant that helps users tailor CVs."},
                                {
                                    "role": "system",
                                    "content": "You are a helpful assistant that helps users tailor CVs and returns responses in strict JSON format. Do not use Markdown, quotes, or any explanatory text. Only output a plain JSON object like the following:\
{\
    \"summary\": \"One-paragraph professional summary\",\
    \"experienceBullets\": [\"Bullet 1\", \"Bullet 2\", \"Bullet 3\"],\
	\"coverLetter\": \"A short personalized cover letter (up to 120 words)\"\
}"
                                },
                                {role: "user", content: prompt}
                            ]
                        })
                    });

                    const result = await response.json();
                    const content = result.choices?.[0]?.message?.content || "{}";

                    let parsed;
                    try {
                        parsed = JSON.parse(content);
                    } catch (e) {
                        console.error("Ошибка парсинга JSON из AI:", content);
                        alert("AI ответил некорректно. Попробуй снова.");
                        return;
                    }

                    (
                        {
                            summary: aiSuggestions.summary = '',
                            experienceBullets: aiSuggestions.experienceBullets = '',
                            coverLetter: aiSuggestions.coverLetter = '',
                        }
                            = parsed
                    );

                } catch (err) {
                    console.error("Ошибка AI API:", err);
                    alert("Ошибка при подключении к AI.");
                }
            },
            addExperience() {
                if (!this.newExperience.company) return;
                this.form.experienceList.push({...this.newExperience});
                this.newExperience = { company: '', position: '', years: '', description: '' };
            },
            removeExperience(index) {
                this.experienceList.splice(index, 1);
            }
        }
    }).mount('#app');
</script>
</body>
</html>
